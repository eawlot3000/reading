Sure, here's the translation:

===============================================================================
blog.notryan.com/009.txt                                       2020年5月5日周二
Ryan Jacobs                                                      05:40:00 -0700
                           100行C语言代码，隐藏在一个壁橱里
                           . . . . . . . . . . . . . .
===============================================================================

更新：
  哇，这个比我预期的吸引了更多流量。我将在后续文章中更新，详细介绍实现
  server.c的步骤。我为你们准备了一些关于路径遍历的有趣提示。
  另外，现在服务器已经能够防止随机的netcat垃圾数据，这些数据不符合
  HTTP/1.1规范。我们通过拒绝不符合基本条件的请求来实现这一点：以“GET ”开头，
  至少还有一个空格，不包含任何'/'字符。

  此外，我刚刚将服务器转换为使用fork()加上accept()。
  吞吐量从每秒20k个请求下降到8k... 这是因为进程分叉的开销。
  但现在我们可以处理并发请求。我认为这是值得的权衡。

-------------------------------------------------------------------------------

嘿！我想我已经完成了。我为达到的功能完整性感到骄傲。

这个博客现在几乎完全是自托管的。我正在我的壁橱里运行它，用的是Thinkpad
T440p笔记本电脑！查看源代码请访问 https://blog.notryan.com

这是堆栈的样子：
  * KVM虚拟机 -> Void Linux

    * 它可以在我的局域网上实时迁移到任何设备，零停机时间。
      KVM真的很酷！它不断地传输RAM，直到完全同步。这大约需要30秒。

    * VM的磁盘存储在NFS挂载的DRBD（分布式复制块设备）上。如果你之前没有
      听说过DRBD，那么你真的很幸运。
      哦，它只是一些作为内核模块操作的非常可靠的块设备复制软件。还有什么？
      它自2.6内核版本发布以来就一直在主线树中。所以你可能已经有了！只需
      安装用户空间工具。

  * server.c HTTP服务器 (https://blog.notryan.com/server.c)

  * Let's Encrypt（通过Redbird）

  * FRP（快速反向代理）-> Vultr VPS（207.246.103.60入口IPv4）
    * $3.50/月是能作为我的入口的带有IPv4地址的机器的最低价格
      它查看HTTP的`Host:`头部来决定如何将请求路由到不同的VM。

理论上，我可以在我的本地路由器上开放一个端口，让ISP充当入口。但...我不太愿意
暴露我的WAN的IP地址，以防有人决定DDOS我的网络。

-------------------------------------------------------------------------------
                                   节点

  1. 我的壁橱里还运行着什么？
  2. server.c
  3. 远离GitHub
  4. 远离Netlify / Cloudflare
  5. rss.c
  6. 未来计划
-------------------------------------------------------------------------------
                        我的壁橱里还运行着什么？

* https://videos.rmj.us
* https://notryan.com
* https://notryan.com/pdf
* WebFPGA (https://beta.webfpga.io)
* WebFPGA论坛 (https://forum.webfpga.com)

我真的对我的家庭网络ISP（洛杉矶Spectrum）上Discourse论坛的响应速度感到惊讶。

此外，去尝试在WebFPGA IDE上运行一个综合作业 -- 在我们的本地服务器上甚至更快。

看看这样，云VPS在计算能力方面是完全的坑。我租用VPS的两个原因是：正常运行时间和网络访问。
拥有一个公开可达的IP地址对于任何网络应用程序来说都是必须的。
大多数VPS提供商每月收费5美元，提供一个vCore和512MB的RAM。我可以在eBay上买一个
二手的Thinkpad T440p，价格略高于100美元。它有8个vCore和8GB的RAM。它的电池寿命为四小时。
如果有人不小心触发断路器，笔记本电脑也不会死机。这就像在服务器中内置了一个自动UPS！

通过将所有东西转移到本地机器上，我已经将WebFPGA服务器的费用
从每月80美元（DigitalOcean）降低到3.50美元，用于IPv4入口。我在本地安装了一个完整的Kuberenetes，
托管后端。是的，可能会有停机时间。但在三年中只停电两次。而且
互联网从未中断。我有冗余计划。在收到通知后的10-15分钟内，我可以启动同样的
集群设置。但老实说，我过去认为停机时间是世界末日，但我发现大多数用户
对此相对宽容。不过这不是懈怠的借口！
我们都梦想着100%的正常运行时间。我对99.9%的正常运行时间感到满意；那是
每月大约9小时。不错。

-------------------------------------------------------------------------------
                                    server.c

  ryan@kk ~ $ wrk http://localhost:8080

  运行10秒测试 @ http://localhost:8080
    2个线程和10个连接
    线程统计   平均      标准差     最大   +/- 标准差
      延迟   427.45微秒  230.79微秒   5.64毫秒   87.28%
      每秒请求数     9.09k     1.03k   14.45k    63.68%
    181879个请求在10.10秒内, 读取了198.26MB数据

  每秒请求:  18008.57
  每秒传输:     19.63MB

我在开发这个服务器时做了一些假设。所以有一些_quirks_。特别是，服务器有两种内容类型模式。
它要么以`text/html`的形式提供index.html...要么以`text/plain`的形式提供其他所有内容。
此外，它使用阻塞输入/输出：accept()->read()->write()->shutdown()。
有人可以...通过运行`nc remote.name 80`而不发送任何数据，阻止下一个用户获取，
阻塞服务器的任何请求。但由于这个服务器位于一个查看HTTP头部中的`Host:`字段的代理之后...
我们可以假设我们自己的代理不会搞砸我们。恶意长请求不会伤害我们。

-------------------------------------------------------------------------------
                            远离GitHub

与通过SSH推送到VPS相比，推送到Github明显慢。此外，使用自己的机器可以做*不道德的事情*，
比如推送100MB的文件，如果你愿意的话。我已经版本控制了，
很多主要内容根本不是文本文件的超大仓库。
你可以尽情地羞辱我，但能够穿越我的照片/视频收藏太棒了。我不在乎我的2GB仓

不管你怎么羞辱我，但能够通过我的照片/视频集合进行时光旅行是非常棒的。我不在乎我的2GB的仓库在磁盘上占用了4GB……抛开题外话，这里是将文本文件推送到Github和我的VPS所需的时间。（注：VPS路径是客户端->Vultr->VPS）

# 将更改推送到简单文本文件所需的时间。
ryan@kk ~/blog.notryan.com $ time git push origin
实际 0m5.123s

ryan@kk ~/blog.notryan.com $ time git push mir
实际 0m1.423s

-------------------------------------------------------------------------------
                     从Netlify / Cloudflare转移

之前，我的静态站点部署方法是推送到Github，
然后Netlify自动接收，构建并部署。但是...
Netlify使用CDN，传播需要时间。最重要的是，他们的
构建过程对于我的用例来说不是最高效的，因为他们
需要完整地克隆git并启动我猜是一个Docker容器
来安装Node.js/Ruby等。平均可见时间大约是2分钟。
其中一小部分是Cloudflare为了“加速”而缓存网站。我已经
禁用了我的Cloudflare代理。我不希望互联网过度依赖
这些家伙，所以我正在自行托管。

现在，我的当前流程在不到一秒内构建并部署。而且我的站点
立即上线。我并不预期每秒收到成千上万的请求
和全球访问平等。我真的不需要CDN... 对不起，如果我的网站在你居住的地方
加载时间长了100ms。

我的当前构建如下：
  git push
    -> 触发一个git post-update钩子
      -> git restore .
      -> git pull
      -> ./build.sh

这适用于我的整个站点。不仅仅是我的博客。这很好，因为它只是
拉取我所做的微小更改。构建脚本如此之快，以至于
我甚至不需要分支处理。当我部署时，我可以在
客户端的终端看到完整的日志。例如，这次推送在不到
一秒内上线：

  ryan@kk ~/blog.notryan.com $ git push

  枚举对象：7，完成。
  计算对象：100%（7/7），完成。
  通过最多4个线程进行Delta压缩
  压缩对象：100%（4/4），完成。
  写入对象：100%（4/4），1.50 KiB | 1.50 MiB/s，完成。
  总计4（delta 3），重复使用0（delta 0），重复打包0
  远程：从/home/ryan/_enc/notryan.com
  远程：0c9c211d..aa11aa43  master -> origin/master
  远程：由'recursive'策略合并。
  远程：blog/009.txt.draft | 48 +++++++++++++++++++++++++++++++++++------
  远程：1个文件更改，42次插入(+)，6次删除(-)
  到 mir:_enc/notryan.com.git
     0c9c211d..aa11aa43  master -> master

-------------------------------------------------------------------------------
                                     rss.c

啊！好老的RSS。我最近自己“发现”了RSS（有些人
可能会觉得疯狂。）

我认为这非常了不起。我已经将我所有的YouTube订阅
转换为RSS，在他们发布新视频时，这些视频会出现在Thunderbird中。我不
需要再处理YouTube分心/耗时的侧边栏推荐
了。视频链接和标题只会出现在我的RSS阅读器中——然后我可以
使用`mpv

`来观看视频。

无论如何，我想在我的网站上提供符合规范的RSS。我已经创建了一个C
程序来做到这一点。订阅以接收未来的帖子通知！

  https://blog.notryan.com/rss.c
  https://blog.notryan.com/rss.xml

-------------------------------------------------------------------------------
                                  未来计划

我正在考虑将server.c转换为使用poll()而不是阻塞
系统调用。我不想引入太多复杂性。我更喜欢poll()的
函数原型，而不是select()/epoll()，所以我可能会坚持
使用它。棘手的部分是弄清楚如何同步两个线程。我会
更喜欢使用简单的fork()调用，但是进程不会有共享
内存......无论如何，那是未来的事情。

将会很好的功能：
  * HTTPS
  * HEAD请求
  * 通过文件扩展名确定Content-Type，以便我可以正确地提供图像
-------------------------------------------------------------------------------

无论如何，感谢您的阅读！
  --（绝对不是）Ryan

-------------------------------------------------------------------------------

https://www.reddit.com/r/programming/comments/gdxh3w/http_blog_server_100_lines_of_c_in_a_closet/
https://www.reddit.com/r/C_Programming/comments/gdy2av/serverc_100_lines_of_c_in_a_closet/
